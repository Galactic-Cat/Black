<!DOCTYPE html>
<div class="mdc-elevation--z3 box">
  <h1 class="mdc-typography--title">End of tease</h1>
  <p>
    <span class="exit-user" style="color: red; display: none;">So you decided to quit the tease on your own?<br></span>
    <span class="exit-end" style="color: lime; display: none;">You finished a complete tease!<br></span>
    You've teased <span class="tease-total"></span> times now.<br>
    Let's see how you did.<br>
    You came <span class="cum-total"></span> times.<br>
    <span class="cum-full"></span> of which were full orgasms and you ruined <span class="cum-ruin"></span> of them.<br>
    You edged <span class="cum-edge"></span> times.<br>
    <span class="cum-nonAllowed-line" style="color: red; display: none;">I see that you came <span class="cum-nonAllowed"></span> without permission! Bad boy.</span>
    <span class="cum-allowed-line" style="color: lime; display: none;">And you didn't cum without permission.</span>
  </p>
  <br>
  <div id="punishment-notset" style="display: none;">
    <span>Your punishment card folder hasn't been set.</span>
    <button id="punishmentSetButton" class="mdc-button mdc-button--raised mdc-button--primary mdc-ripple" data-mdc-auto-init="MDCRipple">Browse</button>
  </div>
  <div id="punishment-group" style="display: none;">
    <span>You still have <span class="punishment"></span> punishments to draw.</span>
    &nbsp;&nbsp;
    <button id="punishmentButton" type="button" class="mdc-button mdc-button--raised mdc-button--primary mdc-ripple" data-mdc-auto-init="MDCRipple">Draw a punishment card</button>
    <br>
    <span id="noPunishments" style="color: red; display: none;">No punishments were found!</span>
    <br>
    <div id="punishmentDisplay" style="background-color: rgba(0, 0, 0, 0.2); padding: 5px; overflow-x: auto; display: flex;"></div>
    <br>
  </div>
  <br>
  <div>
    <button type="button" id="homs-btn" class="mdc-button mdc-button--raised mdc-ripple" data-mdc-auto-init="MDCRipple" onclick="swapper.swap('home')">Return Home</button>
    &nbsp;&nbsp;
    <button type="button" id="rete-btn" class="mdc-button mdc-button--raised mdc-ripple" data-mdc-auto-init="MDCRipple" onclick="swapper.swap('setup')">Go to Tease Dashboard</button>
    <button type="button" id="repo-btn" class="mdc-button mdc-button--raised mdc-ripple" data-mdc-auto-init="MDCRipple" onclick="generateReport()" style="float: right;">Generate Tease Report</button>
  </div>
</div>

<script type="text/javascript">
  /* global config, $, dialog, fs */
  function hashCode (string) {
    var hash = 0
    var i, chr
    if (string.length === 0) return hash
    for (i = 0; i < string.length; i++) {
      chr = string.charCodeAt(i)
      hash = ((hash << 5) - hash) + chr
      hash |= 0 // Convert to 32bit integer
    }
    return hash
  }

  if (typeof teaseExit === 'undefined') {
    var teaseExit = config.get('teaseExit')
    var cumInfo = config.get('stats.lastTease.cumming')
    var punish = config.get('stats.lastTease.cumming.nonAllowed')
    var sublevel = config.get('profile.sublevel')
    var teaseTotal = config.get('stats.teases.total')
  } else {
    teaseExit = config.get('teaseExit')
    cumInfo = config.get('stats.lastTease.cumming')
    punish = config.get('stats.lastTease.cumming.nonAllowed')
    sublevel = config.get('profile.sublevel')
    teaseTotal = config.get('stats.teases.total')
  }
  $('#punishmentDisplay').hide()
  if (teaseExit === 'user') {
    if (sublevel > -5) sublevel--
    punish++
    $('.exit-user').slideDown(200)
  } else if (teaseExit === 'end') {
    if (sublevel < 5) sublevel++
    $('.exit-end').slideDown(200)
  }
  // $('#generateTeaseReport')
  $('.tease-total').text(teaseTotal)
  $('.cum-total').text(cumInfo.full + cumInfo.ruin)
  $('.cum-full').text(cumInfo.full)
  $('.cum-edge').text(cumInfo.edge)
  $('.cum-ruin').text(cumInfo.ruin)
  if (cumInfo.nonAllowed > 0) {
    if (sublevel > -5) sublevel--
    $('.cum-nonAllowed').text(cumInfo.nonAllowed)
    $('.cum-nonAllowed-line').slideDown(200)
  } else {
    if (sublevel < 5) sublevel++
    $('.cum-allowed-line').slideDown(200)
  }
  if (punish > 0) {
    if (config.get('stats.total.punishments.deserved') === undefined) config.set('stats.total.punishments.deserved', 0)
    config.set('stats.total.punishments.deserved', config.get('stats.total.punishments.deserved') + punish)
    if (config.get('profile.punishment') === undefined) {
      $('#punishment-notset').slideDown(200)
    } else {
      $('.punishment').text(punish)
      $('#punishment-group').slideDown(200)
    }
  } else {
    $('#homs-btn').addClass('mdc-button--primary')
    $('#rete-btn').addClass('mdc-button--accent')
  }

  if (config.get('settings.autoReport')) {
    if (typeof config.get('settings.autoReportPath')[0] === 'string') {
      $('#repo-btn').hide()
      generateReport(config.get('settings.autoReportPath')[0])
    }
  }

  $('#punishmentSetButton').click(_ => {
    dialog.showOpenDialog({
      title: 'Select Punisment Cards Folder',
      properties: ['openDirectory']
    }, (path) => {
      if (path !== '' && path !== undefined) {
        config.set('profile.punishment', path)
        $('#punishment-notset').slideUp(200)
        if (punish > 0) {
          $('.punishment').text(punish)
          $('#punishment-group').slideDown(200)
        }
      }
    })
  })

  $('#punishmentButton').click(_ => {
    let path = config.get('profile.punishment')[0]
    let fold = fs.readdirSync(path)
    let pick = []
    if (config.get('stats.total.punishments.drawn') === undefined) config.set('stats.total.punishments.drawn', 0)
    fold.forEach((item) => {
      if (item.lastIndexOf('.') > 0) pick.push(item)
    })
    if (pick.length === 0) {
      $('#noPunishments').slideDown(200)
    } else {
      config.set('stats.total.punishments', config.get('stats.total.punishments') + 1)
      let punishment = pick[Math.floor(Math.random() * pick.length)]
      $('#punishmentDisplay').prepend('<img src="' + path + '/' + punishment + '" class="punishment-card" />')
      $('#punishmentDisplay').slideDown(200)
      if (punish > 0) punish--
      $('.punishment').text(punish)
      if (punish === 0) {
        $('#punishmentButton').removeClass('mdc-button--primary')
        $('#homs-btn').addClass('mdc-button--primary')
        $('#rete-btn').addClass('mdc-button--accent')
      }
    }
  })

  function generateReport (path) {
    let date = new Date()
    let report = [
      'Black Tease Report - ' + date.getFullYear() + '/' + (date.getMonth() + 1) + '/' + date.getDate() + ' ' + date.getHours() + ':' + date.getMinutes(),
      'Name: ' + config.get('profile.name.real'),
      '',
      'Card information:',
      '  Pictures: ' + config.get('teaseslave.teaseParams.pictureAmount'),
      '  Cards: ' + Object.keys(config.get('teaseslave.icl')).length,
      '',
      'Cumming:',
      '  Full: ' + config.get('stats.lastTease.cumming.full'),
      '  Ruined: ' + config.get('stats.lastTease.cumming.ruin'),
      '  Edges: ' + config.get('stats.lastTease.cumming.edge'),
      '  Without Permission: ' + config.get('stats.lastTease.cumming.nonAllowed'),
      '',
      'You should be considered a ',
      ''
    ]
    let token = hashCode(report.join('\r\n'))
    report.push('Verification token: ' + token)
    if (config.get('profile.sublevel') < -2) {
      report[13] += (config.get('settings.subtags.bad') || 'bad') + ' '
    } else if (config.get('profile.sublevel') > 2) {
      report[13] += (config.get('settings.subtags.good') || 'good') + ' '
    } else {
      report[13] += (config.get('settings.subtags.neutral') || 'boring') + ' '
    }
    report[13] += config.get('profile.gender.nick')
    if (path === undefined) {
      dialog.showSaveDialog({
        title: 'Save Tease Report',
        defaultPath: config.get('profile.name.real') + ' Tease Report ' + date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate() + ' ' + date.getHours() + '_' + date.getMinutes() + '.txt',
        buttonLabel: 'Save Report'
      }, (gPath) => {
        if (gPath !== undefined) {
          report = report.join('\r\n')
          fs.writeFileSync(gPath, report)
        } else {
          console.error('<teaseend.html / generateReport>\nNo path specified. Report not saved.')
        }
      })
    } else {
      report = report.join('\r\n')
      path += '\\' + config.get('profile.name.real') + ' Tease Report ' + date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate() + ' ' + date.getHours() + '_' + date.getMinutes() + '.txt'
      fs.writeFileSync(path, report)
    }
  }
</script>
