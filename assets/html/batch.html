<!DOCTYPE html>
<div id="bcc-0" class="mdc-elevation--z3 box">
  <h1 class="mdc-typography--title">Batch Card Maker</h1>
  <h1 class="mdc-typography--subheading2">Create multiple cards at once.</h1>
  <div class="mdc-form-field">
    <div class="mdc-checkbox">
      <input id="bcc-save" type="checkbox" class="mdc-checkbox__native-control" />
      <div class="mdc-checkbox__background">
        <svg class="mdc-checkbox__checkmark" viewbox="0 0 24 24">
          <path class="mdc-checkbox__checkmark__path" fill="none" stroke="white" d="M1.73,12.91 8.1,19.28 22.79,4.59" />
        </svg>
        <div class="mdc-checkbox__mixedmark"></div>
      </div>
    </div>
    <label for="bcc-save">Save settings for later use</label>
  </div>
  <hr>

  <h1 class="mdc-typography--subheading1">Card Type</h1>
  <div class="mdc-form-field">
    <div class="mdc-radio">
      <input class="mdc-radio__native-control" type="radio" id="bcc-type-1" name="bcc-type" />
      <div class="mdc-radio__background">
        <div class="mdc-radio__outer-circle"></div>
        <div class="mdc-radio__inner-circle"></div>
      </div>
    </div>
    <label for="bcc-type-1">CTI 1 Cards</label>
  </div>
  <br>
  <div class="mdc-form-field">
    <div class="mdc-radio">
      <input class="mdc-radio__native-control" type="radio" id="bcc-type-s" name="bcc-type" />
      <div class="mdc-radio__background">
        <div class="mdc-radio__outer-circle"></div>
        <div class="mdc-radio__inner-circle"></div>
      </div>
    </div>
    <label for="bcc-type-s">CTI S (script) Cards</label>
  </div>
  <br>
  <div class="mdc-form-field" style="display: none;">
    <div class="mdc-checkbox">
      <input id="bcc-convert" type="checkbox" class="mdc-checkbox__native-control" />
      <div class="mdc-checkbox__background">
        <svg class="mdc-checkbox__checkmark" viewbox="0 0 24 24">
          <path class="mdc-checkbox__checkmark__path" fill="none" stroke="white" d="M1.73,12.91 8.1,19.28 22.79,4.59" />
        </svg>
        <div class="mdc-checkbox__mixedmark"></div>
      </div>
    </div>
    <label for="bcc-convert">Convert CTI 1 cards to CTI S</label>
  </div>
  <br>

  <h1 class="mdc-typography--subheading1">Image Folder</h1>
  <div class="mdc-form-field">
    <button type="button" class="mdc-button mdc-button--primary mdc-ripple" data-mdc-auto-init="MDCRipple" id="bcc-image-folder">Select Folder</button>
    <label id="bcc-image-folder-label" class="path-box" style="display: none;"></label>
  </div><br>
  <div class="mdc-form-field">
    <div class="mdc-checkbox">
      <input id="bcc-image-folder-recursive" type="checkbox" class="mdc-checkbox__native-control">
      <div class="mdc-checkbox__background">
        <svg class="mdc-checkbox__checkmark" viewbox="0 0 24 24">
          <path class="mdc-checkbox__checkmark__path" fill="none" stroke="white" d="M1.73,12.91 8.1,19.28 22.79,4.59" />
        </svg>
        <div class="mdc-checkbox__mixedmark"></div>
      </div>
    </div>
    <label for="bcc-image-folder-recursive">Recurse into image folder</label>
  </div>
  <h1 class="mdc-typography--subheading1">Image Selection</h1>
  <div class="mdc-form-field">
    <div class="mdc-radio">
      <input class="mdc-radio__native-control" type="radio" id="bcc-image-select-order" name="bcc-image-select" />
      <div class="mdc-radio__background">
        <div class="mdc-radio__outer-circle"></div>
        <div class="mdc-radio__inner-circle"></div>
      </div>
    </div>
    <label for="bcc-image-select-order">In Order</label>
  </div>
  <br>
  <div class="mdc-form-field">
    <div class="mdc-radio">
      <input class="mdc-radio__native-control" type="radio" id="bcc-image-select-manual" name="bcc-image-select" />
      <div class="mdc-radio__background">
        <div class="mdc-radio__outer-circle"></div>
        <div class="mdc-radio__inner-circle"></div>
      </div>
    </div>
    <label for="bcc-image-select-manual">Manual</label>
  </div>
  <br>
  <div class="mdc-form-field">
    <div class="mdc-radio">
      <input class="mdc-radio__native-control" type="radio" id="bcc-image-select-random" name="bcc-image-select" />
      <div class="mdc-radio__background">
        <div class="mdc-radio__outer-circle"></div>
        <div class="mdc-radio__inner-circle"></div>
      </div>
    </div>
    <label for="bcc-image-select-random">Random</label>
  </div>
  <br>
  <br>

  <h1 class="mdc-typography--subheading1">Save Location</h1>
  <div class="mdc-form-field">
    <button type="button" class="mdc-button mdc-button--primary mdc-ripple" data-mdc-auto-init="MDCRipple" id="bcc-save-folder">Select Folder</button>
    <label id="bcc-save-folder-label" class="path-box" style="display: none;"></label>
  </div>
  <br>
  <div class="mdc-form-field">
    <div class="mdc-checkbox">
      <input id="bcc-save-folder-sort" type="checkbox" class="mdc-checkbox__native-control" />
      <div class="mdc-checkbox__background">
        <svg class="mdc-checkbox__checkmark" viewbox="0 0 24 24">
          <path class="mdc-checkbox__checkmark__path" fill="none" stroke="white" d="M1.73,12.91 8.1,19.28 22.79,4.59" />
        </svg>
        <div class="mdc-checkbox__mixedmark"></div>
      </div>
    </div>
    <label for="bcc-save-folder-sort">Sort images by type in subfolders</label>
  </div>
  <br>

  <hr>
  <div style="display: flex;">
    <button type="button" class="mdc-button mdc-button--secondary mdc-ripple" data-mdc-auto-init="MDCRipple" onclick="swapper.swap('cardmaker')">Regular Card Maker</button>
    <button type="button" class="mdc-button mdc-button--primary mdc-ripple" data-mdc-auto-init="MDCRipple" id="bcc-0-next" style="margin: 0 0 0 auto;" disabled>Next</button>
  </div>
</div>

<div id="bcc-1" class="mdc-elevation--z3 box" style="display: none;">
  <h1 class="mdc-typography--title">Batch Card Maker</h1>
  <h1 class="mdc-typography--subheading2">General Card Information</h1>
  <hr>
  <div class="mdc-textfield" data-mdc-auto-init="MDCTextfield">
    <input type="text" id="bcc-author" class="mdc-textfield__input" />
    <label for="bcc-author" class="mdc-textfield__label">Author</label>
  </div>
  <br>
  <div class="mdc-textfield" data-mdc-auto-init="MDCTextfield">
    <input type="text" id="bcc-deck-name" class="mdc-textfield__input" />
    <label for="bcc-deck-name" class="mdc-textfield__label">Deck Name</label>
  </div>
  <br>
  <h1 class="mdc-typography--subheading1">Deck Image</h1>
  <div class="mdc-form-field">
    <button type="button" id="bcc-deck-image" class="mdc-button mdc-button--primary mdc-ripple" data-mdc-auto-init="MDCRipple">Select Image</button>
    <label id="bcc-deck-image-label" class="path-box" style="display: none;"></label>
  </div>

  <hr>
  <div style="display: flex;">
    <button type="button" class="mdc-button mdc-ripple" data-mdc-auto-init="MDCRipple" id="bcc-1-previous">Previous</button>
    <button type="button" class="mdc-button mdc-button--primary mdc-ripple" data-mdc-auto-init="MDCRipple" id="bcc-1-next" style="margin: 0 0 0 auto;">Next</button>
  </div>
</div>

<div id="bcc-2" class="mdc-elevation--z3 box" style="display: none;">
  <h1 class="mdc-typography--title">Batch Card Maker</h1>
  <h1 class="mdc-typography--subheading2">Card Overview</h1>
  <hr>
  <table style="width: 100%;">
    <thead>
      <th>Type</th><th>Image</th><th>Edit</th><th>Preview</th><th>Delete</th>
    </thead>
    <tbody id="bcc-cardList">

    </tbody>
  </table>
  <style media="screen">
    #bcc-cardList i {
      cursor: pointer;
    } #bcc-cardList td, #bcc-4-list td {
      text-align: center;
    }
  </style>
  <div id="bcc-imageLoad">
    <br>
    <p class="mdc-typography--subheading1">Loading images, please wait...</p>
    <div role="progressbar" class="mdc-linear-progress mdc-linear-progress--indeterminate mdc-linear-progress--reversed" style="background-color: rgba(0, 0, 0, 0.2);">
      <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
        <span class="mdc-linear-progress__bar-inner"></span>
      </div>
      <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
        <span class="mdc-linear-progress__bar-inner"></span>
      </div>
    </div>
    <br>
  </div>
  <br>
  <button type="button" id="bcc-card-add" class="mdc-button mdc-button--primary mdc-ripple" data-mdc-auto-init="MDCRipple" onclick="$('#bcc-new').trigger('openup')"><i class="material-icons mdc-button__icon">add</i>Add Card</button>
  <button type="button" id="bcc-card-clear" class="mdc-button mdc-ripple" data-mdc-auto-init="MDCRipple"><i class="material-icons mdc-button__icon">delete_sweep</i>Delete All</button>

  <hr>
  <div style="display: flex;">
    <button type="button" class="mdc-button mdc-ripple" data-mdc-auto-init="MDCRipple" id="bcc-2-previous">Previous</button>
    <button type="button" class="mdc-button mdc-button--primary mdc-ripple" data-mdc-auto-init="MDCRipple" id="bcc-2-next" style="margin: 0 0 0 auto;" disabled>Next</button>
  </div>
</div>

<div id="bcc-new" style="width: 100vw; height: calc(100vh - 24px); z-index: 2; background-color: rgba(0, 0, 0, 0.2); position: fixed; top: 24px; display: none;">
  <div class="mdc-elevation--z3 box" style="max-width: 600px;">
    <h1 class="mdc-typography--subheading2">New Card<span id="bcc-new-cancel" class="material-icons" style="cursor: pointer; float: right;">close</span></h1>
    <hr>
    <div class="mdc-textfield" data-mdc-auto-init="MDCTextfield">
      <input type="text" id="bcc-new-type" class="mdc-textfield__input" />
      <label for="bcc-new-type" class="mdc-textfield__label">Card Type</label>
    </div>
    <br>
    <div class="mdc-textfield mdc-textfield--textarea" data-mdc-auto-init="MDCTextfield">
      <textarea id="bcc-new-text" class="mdc-textfield__input" rows="8" cols="40"></textarea>
      <label for="bcc-new-text" class="mdc-textfield__label" style="background-color: rgba(0, 0, 0, 0);">Card Text</label>
    </div>
    <br>
    <div id="bcc-new-gender" class="mdc-select" role="listbox" tabindex="0">
      <span class="mdc-select__selected-text">Neutral (All genders)</span>
      <div class="mdc-simple-menu mdc-select__menu">
        <ul class="mdc-list mdc-simple-menu__items">
          <li class="mdc-list-item" role="option" id="bcc-new-gender-neutral" tabindex="0">Neutral</li>
          <li class="mdc-list-item" role="option" id="bcc-new-gender-male" tabindex="0">Male</li>
          <li class="mdc-list-item" role="option" id="bcc-new-gender-female" tabindex="0">Female</li>
          <li class="mdc-list-item" role="option" id="bcc-new-gender-transsexual" tabindex="0">Transsexual</li>
          <li class="mdc-list-item" role="option" id="bcc-new-gender-straightcouple" tabindex="0">Straight Couple</li>
          <li class="mdc-list-item" role="option" id="bcc-new-gender-gaycouple" tabindex="0">Gay Couple</li>
          <li class="mdc-list-item" role="option" id="bcc-new-gender-lesbiancouple" tabindex="0">Lesbian Couple</li>
        </ul>
      </div>
    </div>
    <br>
    <h1 class="mdc-typography--subheading1">Card Image<span id="bcc-new-image-sort" class="mdc-theme--secondary"></span></h1>
    <div class="mdc-form-field">
      <button type="button" id="bcc-new-image" class="mdc-button mdc-button--primary mdc-ripple" data-mdc-auto-init="MDCRipple">Select Image</button>
      <label id="bcc-new-image-label" class="path-box" style="display: none;"></label>
    </div>
    <br>
    <div class="mdc-form-field">
      <div class="mdc-checkbox">
        <input type="checkbox" class="mdc-checkbox__native-control" id="bcc-new-special" />
        <div class="mdc-checkbox__background">
          <svg class="mdc-checkbox__checkmark" viewbox="0 0 24 24">
            <path class="mdc-checkbox__checkmark__path" fill="none" stroke="white" d="M1.73,12.91 8.1,19.28 22.79,4.59" />
          </svg>
          <div class="mdc-checkbox__mixedmark"></div>
        </div>
      </div>
      <label for="bcc-new-special">This is a special card (white background, black text)</label>
    </div>
    <br>

    <hr>
    <div style="display: flex;">
      <button type="button" class="mdc-button mdc-button--primary mdc-ripple" data-mdc-auto-init="MDCRipple" id="bcc-new-add" style="margin: 0 0 0 auto;" disabled>Add</button>
    </div>
  </div>
</div>

<div id="bcc-preview" style="width: 100vw; height: calc(100vh - 24px); z-index: 2; background-color: rgba(0, 0, 0, 0.2); position: fixed; top: 24px; display: none;">
  <div class="mdc-elevation--z3 box">
    <h1 class="mdc-typography--title">Preview<span id="bcc-preview-close" class="material-icons" style="cursor: pointer; float: right;">close</span></h1>
    <hr>
    <div role="progressbar" class="mdc-linear-progress mdc-linear-progress--indeterminate mdc-linear-progress--reversed" style="background-color: rgba(0, 0, 0, 0.2);">
      <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
        <span class="mdc-linear-progress__bar-inner"></span>
      </div>
      <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
        <span class="mdc-linear-progress__bar-inner"></span>
      </div>
    </div>
    <img id="bcc-preview-image" />
  </div>
</div>

<div id="bcc-ctis" style="width: 100vw; height: calc(100vh - 24px); z-index: 2; background-color: rgba(0, 0, 0, 0.2); position: fixed; top: 24px; display: none;">
  <div class="mdc-elevation--z3 box" style="max-width: 600px;">
    <h1 class="mdc-typography--title">Edit CTIS<span id="bcc-ctis-close" class="material-icons" style="cursor: pointer; float: right;">close</span></h1>
    <div class="mdc-textfield mdc-textfield--disabled" data-mdc-auto-init="MDCTextfield">
      <input type="text" disabled id="bcc-ctis-type" class="mdc-textfield__input">
      <label for="bcc-ctis-type" class="mdc-textfield__label mdc-textfield__label--float-above">Card Type</label>
    </div><br>
    <div class="mdc-textfield mdc-textfield--textarea mdc-textfield--disabled" data-mdc-auto-init="MDCTextfield">
      <textarea id="bcc-ctis-text" disabled rows="4" cols="80" class="mdc-textfield__input"></textarea>
      <label for="bcc-ctis-text" class="mdc-textfield__label mdc-textfield__label--float-above">Card Text</label>
    </div>
    <hr>
    <div class="mdc-textfield mdc-textfield--textarea" data-mdc-auto-init="MDCTextfield">
      <textarea id="bcc-ctis-edit" class="mdc-textfield__input" rows="10" cols="80" style="font-family: monospace;"></textarea>
      <label for="bcc-ctis-edit" class="mdc-textfield__label">CTIS Code:</label>
    </div>
    <hr>
    <div style="display: flow-root;">
      <button type="button" id="bcc-ctis-save" class="mdc-button mdc-button--primary mdc-ripple" data-mdc-auto-init="MDCRipple" style="float: right;">Save</button>
    </div>
  </div>
</div>

<div id="bcc-3" class="mdc-elevation--z3 box" style="display: none;">
  <h1 class="mdc-typography--title">Batch Card Maker</h1>
  <h1 class="mdc-typography--subheading2">Generating Cards...</h1>
  <hr>
  <div id="bcc-3-progress" role="progressbar" class="mdc-linear-progress" style="background-color: rgba(0, 0, 0, 0.2);">
    <!-- <div class="mdc-linear-progress__buffering-dots"></div> -->
    <div class="mdc-linear-progress__buffer mdc-theme--primary-dark-bg"></div>
    <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
      <span class="mdc-linear-progress__bar-inner"></span>
    </div>
    <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
      <span class="mdc-linear-progress__bar-inner"></span>
    </div>
  </div>
</div>

<div id="bcc-4" class="mdc-eleavtion--z3 box" style="display: none;">
  <h1 class="mdc-typography--title">Batch Card Maker</h1>
  <h1 class="mdc-typography--subheading2">Add CTIS behaviour</h1>
  <hr>
  <table style="width: 100%;">
    <thead>
      <th>Type</th><th>Image</th><th>CTIS</th>
    </thead>
    <tbody id="bcc-4-list">

    </tbody>
  </table>
  <hr>
  <div style="display: flex;">
    <button type="button" class="mdc-button mdc-ripple" data-mdc-auto-init="MDCRipple" id="bcc-4-previous">Previous</button>
    <button type="button" class="mdc-button mdc-button--primary mdc-ripple" data-mdc-auto-init="MDCRipple" id="bcc-4-next" style="margin: 0 0 0 auto;">Next</button>
  </div>
</div>

<div id="bcc-5" class="mdc-elevation--z3 box" style="display: none;">
  <h1 class="mdc-typography--title">Batch Card Maker</h1>
  <h1 class="mdc-typography--subheading2">Generating Cards...</h1>
  <hr>
  <div id="bcc-5-progress" role="progressbar" class="mdc-linear-progress" style="background-color: rgba(0, 0, 0, 0.2);">
    <!-- <div class="mdc-linear-progress__buffering-dots"></div> -->
    <div class="mdc-linear-progress__buffer mdc-theme--primary-dark-bg"></div>
    <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
      <span class="mdc-linear-progress__bar-inner"></span>
    </div>
    <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
      <span class="mdc-linear-progress__bar-inner"></span>
    </div>
  </div>
</div>

<div id="bcc-6" class="mdc-elevation--z3 box" style="display: none;">
  <h1 class="mdc-typography--title">Batch Card Maker</h1>
  <h1 class="mdc-typography--subheading2">Cards generated!</h1>
  <hr>
  <h1 class="mdc-typography--body2">Saved your cards to:</h1><br>
  <label id="bcc-saveLoc" class="path-box"></label>
  <button type="button" class="mdc-button mdc-button--raised mdc-ripple" data-mdc-auto-init="MDCRipple" onclick="shell.showItemInFolder(settings('saveFolder') + '/.')">Open Folder</button>
  <hr>
  <div style="display: flex;">
    <button type="button" class="mdc-button mdc-button--primary mdc-ripple" data-mdc-auto-init="MDCRipple" onclick="swapper.swap('batch')">Create more cards</button>
    &nbsp;
    <button type="button" class="mdc-button mdc-ripple" data-mdc-auto-init="MDCRipple" onclick="swapper.swap('home')">Back to Home</button>
  </div>
</div>

<script type="text/javascript">
  /* global $, mdc, dialog, config, fs, Image */
  var cards = {}
  var images = {free: [], taken: []}
  var settings = config.get('batchCardMaker')
  var deckImage = new Image()
  deckImage.src = `file://${__dirname}/cardmaker/cti1-logo.png`
  var tagImage = new Image()
  tagImage.src = `file://${__dirname}/cardmaker/tag.png`
  if (typeof settings === 'object' && settings.save === true) {
    $('#bcc-save').prop('checked', true)
    if (settings.type != null) {
      $('#bcc-type-' + settings.type.substr(3, 1)).prop('checked', true)
      if (settings.type === 'ctis') $('#bcc-convert').parents('.mdc-form-field').show()
      deckImage.src = `file://${__dirname}/cardmaker/${settings.type}-logo.png`
    }
    if (settings.convert === true) $('#bcc-convert').prop('checked', true)
    if (settings.imageFolder != null) {
      $('#bcc-image-folder-label').text(settings.imageFolder).fadeIn(200)
      $('#bcc-image-folder').removeClass('mdc-button--primary')
    }
    if (settings.imageFolderRecursive === true) $('#bcc-image-folder-recursive').prop('checked', true)
    if (settings.imageSelection != null) $('#bcc-image-select-' + settings.imageSelection).prop('checked', true)
    if (settings.saveFolder != null) {
      $('#bcc-save-folder-label').text(settings.saveFolder).fadeIn(200)
      $('#bcc-save-folder').removeClass('mdc-button--primary')
    }
    if (settings.saveFolderSort === true) $('#bcc-save-folder-sort').prop('checked', true)
    if (settings.author != null) $('#bcc-author').val(settings.author)
    if (settings.deckName != null) $('#bcc-deck-name').val(settings.deckName)
    if (settings.deckImage != null) {
      deckImage.src = settings.deckImage
      $('#bcc-deck-image-label').text(settings.deckImage).fadeIn(200)
      $('#bcc-deck-image').removeClass('mdc-button--primary')
    }
  }
  settings = (setting, value) => {
    if (value == null) return config.get('batchCardMaker.' + setting)
    return config.set('batchCardMaker.' + setting, value)
  }

  function getImages (path, recursive) {
    let folder = fs.readdirSync(path)
    let ret = []
    folder.forEach((sub) => {
      let substat = fs.statSync(path + '/' + sub)
      if (substat.isDirectory() && recursive === true && sub !== 'deleted') ret = ret.concat(getImages(path + '/' + sub, true))
      else if (substat.isFile()) ret.push(path + '/' + sub)
    })
    for (let i = 0; i < ret.length; i++) {
      let subExtension = ret[i].split('.').slice(-1)[0]
      if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].indexOf(subExtension.toLowerCase()) === -1) {
        ret.splice(i, 1)
        i--
      }
    }
    return ret
  }

  $('#swapper').ready(_ => {
    // General
    mdc.autoInit()
    mdc.linearProgress.MDCLinearProgress.attachTo($('.mdc-linear-progress')[0]).open()

    function createFitA (srcWidth, srcHeight) {
      let orientation
      let ratio = 1
      if (srcWidth >= srcHeight) orientation = 'landscape'
      else orientation = 'portrait'
      if (orientation === 'landscape') {
        if (srcWidth > 600) ratio = 600 / srcWidth
        if (srcHeight * ratio > 400) ratio = 400 / srcHeight
      } else {
        if (srcHeight > 550) ratio = 550 / srcHeight
        if (srcWidth * ratio > 500) ratio = 500 / srcWidth
      }
      return {orientation: orientation, width: Math.round(srcWidth * ratio), height: Math.round(srcHeight * ratio)}
    }

    function createFitB (srcHeight, srcWidth) {
      let ratio = 1
      if (srcWidth > 94) ratio = 94 / srcWidth
      if (srcHeight * ratio > 94) ratio = 94 / srcHeight
      return {width: Math.round(srcWidth * ratio), height: Math.round(srcHeight * ratio)}
    }

    function textOverflow (ctx, text, cardImageHeight, canvasWidth, canvasHeight, lineHeight) {
      let lines = 1.5
      for (var i = 0; i < text.length; i++) {
        let words = text[i].split(' ')
        let line = ''
        for (var n = 0; n < words.length; n++) {
          let testLine = line + words[n]
          let testWidth = ctx.measureText(testLine).width
          if (testWidth > canvasWidth) {
            lines += 1
            line = ''
          } else line = testLine
        }
        lines += 1
      }
      if ((cardImageHeight + (lines * lineHeight)) > canvasHeight) return (cardImageHeight + (lines * lineHeight)) - canvasHeight
      else return 0
    }

    function properWrite (ctx, text, x, y, maxWidth, lineHeight) {
      let words = text.split(' ')
      let line = ''
      for (var n = 0; n < words.length; n++) {
        let testLine = line + words[n] + ' '
        let testWidth = ctx.measureText(testLine).width
        if (testWidth > maxWidth && n > 0) {
          ctx.fillText(line, x, y)
          line = words[n] + ' '
          y += lineHeight
        } else {
          line = testLine
        }
      }
      ctx.fillText(line, x, y)
      return y + lineHeight
    }

    function cardMaker (card, canvas, callback) {
      canvas = canvas || document.createElement('canvas')
      let context = canvas.getContext('2d')
      let image = new Image()
      let gender = new Image()
      let gendersrc = (card.gender || 'neutral') + (card.special ? '-inverse' : '')
      gender.src = `file://${__dirname}/cardmaker/gendericons/${gendersrc}.png`
      image.src = card.image
      image.onload = _ => {
        console.debug(`Origial card image size: ${image.width}x${image.height}`)
        let cardImageDimensions = createFitA(image.width, image.height)
        console.debug(`Fitted card image: ${cardImageDimensions.orientation}, ${cardImageDimensions.width}x${cardImageDimensions.height}`)
        let deckImageDimensions = createFitB(deckImage.width, deckImage.height)
        if (cardImageDimensions.orientation === 'landscape') {
          canvas.width = 750
          canvas.height = 600
        } else {
          canvas.width = 600
          canvas.height = 750
        }
        context.textBaseline = 'hanging'
        context.font = '18px Arial'
        canvas.height += textOverflow(context, card.text.split('\n'), cardImageDimensions.height + 132, canvas.width, canvas.height, 15)
        let leftBorder = canvas.width / 2 - Math.ceil(cardImageDimensions.width / 2) - 3
        if (card.special) context.fillStyle = '#ffffff'
        else context.fillStyle = '#000000'
        context.fillRect(0, 0, canvas.width, canvas.height)
        context.fill()
        context.beginPath()
        context.lineWidth = '2'
        context.rect(leftBorder, 50, cardImageDimensions.width + 2, cardImageDimensions.height + 2)
        if (card.special) context.strokeStyle = '#000000'
        else context.strokeStyle = '#ffffff'
        context.stroke()
        context.drawImage(image, leftBorder + 1, 51, cardImageDimensions.width, cardImageDimensions.height)
        if (card.special) context.fillStyle = '#000000'
        else context.fillStyle = '#ffffff'
        context.textBaseline = 'hanging'
        context.font = '13px Arial'
        context.fillText('Custom Tease Instructor' + (settings('type') === 'ctis' ? ' Script' : ''), leftBorder - 1, 15)
        context.font = '15px Arial Black'
        context.fillText((settings('deckName') || 'Supplemental'), leftBorder - 1, 30)
        context.textAlign = 'end'
        context.font = '13px Arial'
        context.fillText((settings('author') || 'Anonymous'), leftBorder + cardImageDimensions.width + 4, 32)
        context.textAlign = 'center'
        context.font = '63px Times New Roman'
        context.fillText((card.type || '').toUpperCase(), canvas.width / 2, 71 + cardImageDimensions.height, canvas.width - 6)
        context.font = '18px Arial'
        let liney = cardImageDimensions.height + 134
        for (let i = 0; i < card.text.split('\n').length; i++) {
          liney = properWrite(context, card.text.split('\n')[i], canvas.width / 2, liney, canvas.width - 10, 20)
        }
        context.drawImage(gender, Math.floor((canvas.width / 2 - cardImageDimensions.width / 2) / 2 - (gender.width / 2)) < 0 ? -1 : Math.floor((canvas.width / 2 - cardImageDimensions.width / 2) / 2 - gender.width / 2), 108)
        context.globalAlpha = 0.5
        context.drawImage(deckImage, 4, 4, deckImageDimensions.width, deckImageDimensions.height)
        context.drawImage(tagImage, leftBorder + 5 + cardImageDimensions.width, 50 + cardImageDimensions.height - tagImage.height)
        callback(canvas)
      }
    }

    function generateCards () {
      let fin = 0
      let dfd = $.Deferred()
      let keys = Object.keys(cards)
      for (var i = 0; i < keys.length; i++) {
        dfd.notify('buffer')
        cardMaker(cards[keys[i]], document.createElement('canvas'), (canvas) => {
          cards[keys[fin]].dataURL = canvas.toDataURL('image/png')
          fin++
          dfd.notify('progress')
          if (fin >= Object.keys(cards).length - 1) {
            dfd.resolve()
          }
        })
      }
      return dfd
    }

    function SaveCards (type) {
      let dfd = $.Deferred()
      let keys = Object.keys(cards)
      let n = {}
      let fin = 0
      if (settings('saveFolderSort') !== true) {
        let getF = fs.readdirSync(settings('saveFolder'))
        getF.forEach((file) => {
          n[0] = 0
          if (file.lastIndexOf('.ctis') === -1) {
            if (file.toLowerCase().indexOf(settings.deckName.toLowerCase() + '.' + settings.cardType.toLowerCase()) !== -1) n[0]++
          }
        })
      }
      if (type === 'ctis') {
        keys.forEach((key) => {
          dfd.notify('buffer')
          let filename
          if (settings('saveFolderSort') === true && n[cards[key].type] == null) {
            if (fs.existsSync(settings('saveFolder') + '/' + cards[key].type)) {
              let getF = fs.readdirSync(settings('saveFolder') + '/' + cards[key].type)
              getF.forEach((file) => {
                n[cards[key].type] = 1
                if (file.lastIndexOf('.ctis') === -1) {
                  if (file.toLowerCase().indexOf(settings.deckName.toLowerCase() + '.' + settings.cardType.toLowerCase()) !== -1) n[cards[key].type]++
                }
              })
            } else {
              fs.mkdirSync(settings('saveFolder') + '/' + cards[key].type)
              n[cards[key].type] = 1
            }
            filename = settings('saveFolder') + '/' + cards[key].type + '/' + settings('type').toUpperCase() + '.' + settings('author') + '.' + settings('deckName') + '.' + n[cards[key].type]++
          } else {
            filename = settings('saveFolder') + '/' + settings('type').toUpperCase() + '.' + settings('author') + '.' + settings('deckName') + '.' + n[0]++
          }
          if (settings('convert') !== true) {
            let matches = cards[key].dataURL.match(/^data:.+\/(.+);base64,(.*)$/)
            fs.writeFileSync(filename + '.png', Buffer.alloc(matches[2].length, matches[2], 'base64'))
          }
          fs.writeFileSync(filename + '.ctis', JSON.stringify(cards[key].ctis || ''))
          dfd.notify('progress')
          if (++fin >= Object.keys(cards).length - 1) {
            dfd.resolve()
          }
        })
      } else if (type === 'cti1') {
        keys.forEach((key) => {
          dfd.notify('buffer')
          let filename
          if (settings('saveFolderSort') === true && n[cards[key].type] == null) {
            if (fs.existsSync(settings('saveFolder') + '/' + cards[key].type)) {
              let getF = fs.readdirSync(settings('saveFolder') + '/' + cards[key].type)
              getF.forEach((file) => {
                n[cards[key].type] = 1
                if (file.lastIndexOf('.ctis') === -1) {
                  if (file.toLowerCase().indexOf(settings.deckName.toLowerCase() + '.' + settings.cardType.toLowerCase()) !== -1) n[cards[key].type]++
                }
              })
            } else {
              fs.mkdirSync(settings('saveFolder') + '/' + cards[key].type)
              n[cards[key].type] = 1
            }
            filename = settings('saveFolder') + '/' + cards[key].type + '/' + settings('type').toUpperCase() + '.' + settings('author') + '.' + settings('deckName') + '.' + n[cards[key].type]++
          } else {
            filename = settings('saveFolder') + '/' + settings('type').toUpperCase() + '.' + settings('author') + '.' + settings('deckName') + '.' + n[0]++
          }
          let matches = cards[key].dataURL.match(/^data:.+\/(.+);base64,(.*)$/)
          fs.writeFileSync(filename + '.png', Buffer.alloc(matches[2].length, matches[2], 'base64'))
          dfd.notify('progress')
          if (++fin >= Object.keys(cards).length - 1) {
            dfd.resolve()
          }
        })
      } else {
        dfd.reject('No such type')
      }
      return dfd
    }

    // Screen 0: settings
    $('#bcc-save').on('click', _ => { settings('save', $('#bcc-save').is(':checked')) })

    $('[name="bcc-type"]').on('click', _ => {
      if ($('#bcc-type-1').is(':checked')) {
        settings('type', 'cti1')
        $('#bcc-convert').prop('checked', false).parents('.mdc-form-field').slideUp(200)
        if (deckImage.src === `file://${__dirname}/cardmaker/ctis-logo.png`) deckImage.src = `file://${__dirname}/cardmaker/cti1-logo.png`
      } else if ($('#bcc-type-s').is(':checked')) {
        settings('type', 'ctis')
        $('#bcc-convert').parents('.mdc-form-field').slideDown(200)
        if (deckImage.src === `file://${__dirname}/cardmaker/cti1-logo.png`) deckImage.src = `file://${__dirname}/cardmaker/ctis-logo.png`
      } else settings('type', undefined)
      $('#bcc-0-next').trigger('settingsUpdate')
    })

    $('#bcc-convert').on('click', _ => { settings('convert', $('#bcc-convert').is(':checked')) })

    $('#bcc-image-folder').on('click', _ => {
      dialog.showOpenDialog({
        title: 'Select Image Folder',
        properties: ['openDirectory']
      }, (path) => {
        if (path !== '' && path != null) {
          $('#bcc-image-folder-label').text(path).fadeIn(100)
          $('#bcc-image-folder.mdc-button--primary').removeClass('mdc-button--primary')
          settings('imageFolder', path[0].split('\\').join('/'))
        } else {
          $('#bcc-image-folder-label').fadeOut(100)
          $('#bcc-image-folder:not(.mdc-button--primary)').addClass('mdc-button--primary')
          settings('imageFolder', undefined)
        }
        $('#bcc-0-next').trigger('settingsUpdate')
      })
    })

    $('#bcc-image-folder-recursive').on('click', _ => { settings('imageFolderRecursive', $('#bcc-image-folder-recursive').is(':checked')) })

    $('[name="bcc-image-select"]').on('click', _ => {
      if ($('#bcc-image-select-order').is(':checked')) settings('imageSelection', 'order')
      else if ($('#bcc-image-select-manual').is(':checked')) settings('imageSelection', 'manual')
      else if ($('#bcc-image-select-random').is(':checked')) settings('imageSelection', 'random')
      else settings('imageSelection', undefined)
      $('#bcc-0-next').trigger('settingsUpdate')
    })

    $('#bcc-save-folder').on('click', _ => {
      dialog.showOpenDialog({
        title: 'Select Save Location',
        properties: ['openDirectory']
      }, (path) => {
        if (path !== '' && path != null) {
          $('#bcc-save-folder-label').text(path).fadeIn(100)
          $('#bcc-save-folder.mdc-button--primary').removeClass('mdc-button--primary')
          settings('saveFolder', path[0].split('\\').join('/'))
        } else {
          $('#bcc-save-folder-label').fadeOut(100)
          $('#bcc-save-folder:not(.mdc-button--primary)').addClass('mdc-button--primary')
          settings('saveFolder', undefined)
        }
        $('#bcc-0-next').trigger('settingsUpdate')
      })
    })

    $('#bcc-save-folder-sort').on('click', _ => { settings('saveFolderSort', $('#bcc-save-folder-sort').is(':checked')) })

    $('#bcc-0-next').on('click', _ => {
      if (!$('#bcc-0-next').is(':disabled')) {
        $('#bcc-0').slideUp(200, _ => { $('#bcc-1').slideDown(200) })
      }
    })

    $('#bcc-0-next').on('settingsUpdate', _ => {
      if (settings('type') != null &&
      settings('imageFolder') != null &&
      settings('imageSelection') != null &&
      settings('saveFolder') != null) {
        $('#bcc-0-next').prop('disabled', false)
      } else {
        $('#bcc-0-next').prop('disabled', true)
      }
    })

    $('#bcc-0-next').trigger('settingsUpdate')

    // Step 1: General card info
    $('#bcc-author').on('change', _ => {
      if ($('#bcc-author').val() === '' || $('#bcc-author').val() == null) settings('author', undefined)
      else settings('author', $('#bcc-author').val())
    })

    $('#bcc-deck-name').on('change', _ => {
      if ($('#bcc-deck-name').val() === '' || $('#bcc-deck-name').val() == null) settings('deckName', undefined)
      else settings('deckName', $('#bcc-deck-name').val())
    })

    $('#bcc-deck-image').on('click', _ => {
      dialog.showOpenDialog({
        title: 'Select Deck Image',
        properties: ['openFile'],
        filters: [
          {name: 'Images', extensions: ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'ico']}
        ]
      }, (path) => {
        if (path !== '' && path != null) {
          $('#bcc-deck-image-label').text(path).fadeIn(200)
          $('#bcc-deck-image.mdc-button--primary').removeClass('mdc-button--primary')
          deckImage.src = path[0].split('\\').join('/')
          settings('deckImage', path[0].split('\\').join('/'))
        } else {
          $('#bcc-deck-image-label').fadeOut(200)
          $('#bcc-deck-image:not(.mdc-button--primary)').addClass('mdc-button--primary')
          deckImage.src = './cardmaker/' + (settings('type') || 'cti1') + '-logo.png'
          settings('deckImage', undefined)
        }
      })
    })

    $('#bcc-1-previous').on('click', _ => {
      $('#bcc-1').slideUp(200, _ => { $('#bcc-0').slideDown(200) })
    })

    $('#bcc-1-next').on('click', _ => {
      $('#bcc-1').slideUp(200, _ => {
        $('#bcc-2').slideDown(200, _ => {
          if (!(images.free.length !== 0 || images.taken.length !== 0)) $('#bcc-2').trigger('prep')
        })
      })
    })

    // Step 2: Card Overview
    $('#bcc-2').on('prep', _ => {
      $('#bcc-imageLoad').slideDown(100)
      $('#bcc-card-add, #bcc-card-clear').prop('disabled', true)
      images = {free: [], taken: []}
      images.free = getImages(settings('imageFolder'), settings('imageFolderRecursive'))
      $('#bcc-imageLoad').slideUp(100)
      $('#bcc-card-add, #bcc-card-clear').prop('disabled', false)
    })

    $('#bcc-card-clear').on('click', _ => {
      $('#bcc-cardList tr').remove()
      $('#bcc-2').trigger('prep')
    })

    $('#bcc-new').on('openup', (_, key) => {
      var brandnew = true
      var old = cards[key]
      if (key != null) brandnew = false
      if (brandnew) {
        key = Math.ceil(Math.random() * 10000)
        while (Object.keys(cards).indexOf(key) !== -1) {
          key += 1
          if (key > 10000) key = 1
        }
        cards[key] = {}
        $('#bcc-new-add').text('Add')
      } else {
        $('#bcc-new-type').val(cards[key].type || '')
        $('#bcc-new-text').val(cards[key].text || '')
        if (cards[key].image != null) {
          $('#bcc-new-image.mdc-button--primary').removeClass('mdc-button--primary')
          $('#bcc-new-image-label').text(cards[key].image).show()
          $('#bcc-new-add').prop('disabled', false)
        }
        $('#bcc-new-add').text('Update')
        $('#bcc-new-special').prop('checked', cards[key].special || false)
      }

      var cardImage
      if (settings('imageSelection') !== 'manual') {
        $('#bcc-new-image-sort').text(' (' + settings('imageSelection') + ' selection)')
        $('#bcc-new-image').removeClass('mdc-button--primary')
        if (brandnew) {
          let i = 0
          if (settings('imageSelection') === 'order') {
            if (images.free.length <= 0) {
              images.free = images.taken
              images.taken = []
            }
            images.taken.push(images.free.splice(0, 1)[0])
          } else {
            if (images.free.length <= 0) {
              images.free = images.taken
              images.taken = []
            }
            i = Math.floor(Math.random() * images.free.length)
            images.taken.push(images.free.splice(i, 1)[0])
          }
          cardImage = images.free[i]
          cards[key].image = cardImage
          $('#bcc-new-image-label').text(cardImage).show()
          $('#bcc-new-add').prop('disabled', false)
        }
      }

      $('#bcc-new').fadeIn(200)

      $('#bcc-new-type').on('change', _ => { cards[key].type = $('#bcc-new-type').val() })
      $('#bcc-new-text').on('change', _ => { cards[key].text = $('#bcc-new-text').val().replace(/\r\n/g, '\n') })
      var genderSelect = new mdc.select.MDCSelect($('#bcc-new-gender')[0])
      genderSelect.listen('MDCSelect:change', _ => { cards[key].gender = genderSelect.value.split('-')[3] })

      $('#bcc-new-image').on('click', _ => {
        dialog.showOpenDialog({
          properties: ['openFile'],
          filters: [
            {name: 'Images', extensions: ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'ico']}
          ]
        }, (path) => {
          if (path !== '' && path != null) {
            $('#bcc-new-image-label').text(path).fadeIn(200)
            $('#bcc-new-image.mdc-button--primary').removeClass('mdc-button--primary')
            $('#bcc-new-add').prop('disabled', false)
            cards[key].image = path[0]
          } else {
            $('#bcc-new-image-label').fadeOut(200)
            $('#bcc-new-image:not(.mdc-button--primary)').addClass('mdc-button--primary')
            $('#bcc-new-add').prop('disabled', true)
            cards[key].image = undefined
          }
        })
      })

      $('#bcc-new-special').on('click', _ => { cards[key].special = $('#bcc-new-special').is(':checked') })

      $('#bcc-new-add').on('click', _ => {
        if (!$('#bcc-new-add').is(':disabled')) {
          if (brandnew) $('#bcc-cardList').trigger('add', key)
          else $('#bcc-cardList').trigger('update', key)
          $('#bcc-new').fadeOut(200, _ => { $('#bcc-new').trigger('clear') })
          $('#bcc-new-type, #bcc-new-text, #bcc-new-image, #bcc-new-image-label, #bcc-new-add, #bcc-new-special, #bcc-new-cancel').off()
        }
      })

      $('#bcc-new-cancel').on('click', _ => {
        $('#bcc-new').fadeOut(200, _ => { $('bcc-new').trigger('clear') })
        if (brandnew) delete cards[key]
        else cards[key] = old
        $('#bcc-new-type, #bcc-new-text, #bcc-new-image, #bcc-new-image-label, #bcc-new-add, #bcc-new-special, #bcc-new-cancel').off()
      })
    })

    $('#bcc-cardList').on('add', (_, key) => {
      let card = cards[key]
      $('#bcc-cardList').append(`<tr key="${key}"><td>${card.type}</td><td>${card.image.split('/').slice(-1)[0]}</td><td onclick="$('#bcc-new').trigger('openup', ${key})"><i class="material-icons">edit</i></td><td onclick="$('#bcc-preview').trigger('preview', ${key})"><i class="material-icons">visibility</i></td><td onclick="$('#bcc-cardList').trigger('delete', ${key})"><i class="material-icons">delete</i></td></tr>`)
      $('#bcc-2-next').prop('disabled', false)
    })

    $('#bcc-cardList').on('update', (_, key) => {
      let card = cards[key]
      $('#bcc-cardList tr[key="' + key + '"]').html(`<td>${card.type}</td><td>${card.image.split('/').slice(-1)[0]}</td><td onclick="$('#bcc-new').trigger('openup', ${key})"><i class="material-icons">edit</i></td><td onclick="$('#bcc-preview').trigger('preview', ${key})"><i class="material-icons">visibility</i></td><td onclick="$('#bcc-cardList').trigger('delete', ${key})"><i class="material-icons">delete</i></td>`)
    })

    $('#bcc-cardList').on('delete', (_, key) => {
      delete cards[key]
      $('#bcc-cardList tr[key="' + key + '"]').slideUp(200, function () {
        $(this).remove()
        if ($('#bcc-cardList tr').length === 0) $('#bcc-2-next').prop('disabled', true)
      })
    })

    $('#bcc-preview').on('preview', (_, key) => {
      let card = cards[key]
      let loadme = new mdc.linearProgress.MDCLinearProgress($('#bcc-preview .mdc-linear-progress')[0])
      loadme.open()
      $('#bcc-preview-image').hide()
      $('#bcc-preview').fadeIn(200, _ => {
        cardMaker(card, document.createElement('canvas'), (canvas) => {
          $('#bcc-preview-image').attr('src', canvas.toDataURL('image/png')).slideDown(200)
          loadme.close()
        })
      })
    })

    $('#bcc-preview-close').on('click', _ => {
      $('#bcc-preview').fadeOut(200)
    })

    $('#bcc-2-previous').on('click', _ => {
      $('#bcc-2').slideUp(200, _ => { $('#bcc-1').slideDown(200) })
    })

    $('#bcc-2-next').on('click', _ => {
      if (!$('#bcc-2-next').is(':disabled')) {
        $('#bcc-2').slideUp(200, _ => {
          $('#bcc-3').slideDown(200, _ => { $('#bcc-3').trigger('prep') })
        })
      }
    })

    $('#bcc-new').on('clear', _ => {
      $('#bcc-new-type, #bcc-new-text').val('')
      $('#bcc-new-image:not(.mdc-button--primary)').addClass('mdc-button--primary')
      $('#bcc-new-image-label').text('').hide()
      $('#bcc-new-add').prop('disabled', true)
      $('#bcc-new-special').prop('checked', false)
    })

    var cardGenerationProgress = {
      element: $('#bcc-3-progress')[0],
      bar: new mdc.linearProgress.MDCLinearProgress($('#bcc-3-progress')[0]),
      buffer: 0,
      current: 0,
      max: 0,
      upBuffer: (n) => {
        cardGenerationProgress.buffer += (n || 1)
        cardGenerationProgress.bar.foundation_.setBuffer(cardGenerationProgress.buffer / cardGenerationProgress.max)
      },
      upProgress: (n) => {
        cardGenerationProgress.current += (n || 1)
        if (cardGenerationProgress.current > cardGenerationProgress.buffer) cardGenerationProgress.buffer = cardGenerationProgress.current
        cardGenerationProgress.bar.foundation_.setProgress(cardGenerationProgress.current / cardGenerationProgress.max)
      }
    }

    $('#bcc-3').on('prep', _ => {
      let progressbar = new mdc.linearProgress.MDCLinearProgress($('#bcc-3-progress')[0])
      progressbar.foundation_.setProgress(0)
      progressbar.foundation_.setBuffer(0)
      let max = Object.keys(cards).length
      let progress = 0
      let buffer = 0
      generateCards().then(_ => {
        setTimeout(_ => {
          $('#bcc-3').slideUp(200, _ => {
            $('#bcc-4').trigger('prep')
          })
        }, 500)
      }, (err) => {
        if (err !== undefined) console.error('Error whilst generating cards:\n', err)
      }, (prog) => {
        if (prog === 'buffer') progressbar.foundation_.setBuffer(++buffer / max - 1)
        else if (prog === 'progress') progressbar.foundation_.setProgress(++progress / max - 1)
      })
    })

    $('#bcc-4').on('prep', _ => {
      if (settings('type') === 'ctis') {
        for (let i = 0; i < Object.keys(cards).length; i++) {
          let card = cards[Object.keys(cards)[i]]
          $('#bcc-4-list').append(`<tr key="${Object.keys(cards)[i]}"><td>${card.type}</td><td>&nbsp;${card.image.split('/').slice(-1)}&nbsp;</td><td><button type="button" class="mdc-button mdc-button--secondary" onclick="$('#bcc-ctis').trigger('edit', ${Object.keys(cards)[i]})">Edit</button>&nbsp;<button type="button" class="mdc-button" onclick="$('#bcc-ctis').trigger('clear', ${Object.keys(cards)[i]})">Clear</button></td></tr>`)
        }
        $('#bcc-4').slideDown(200)
      } else {
        $('#bcc-5').trigger('prep')
        $('#bcc-5').slideDown(200)
      }
    })

    $('#bcc-4-previous').click(_ => {
      $('#bcc-4').slideUp(200, _ => {
        $('#bcc-2').slideDown(200)
      })
    })

    $('#bcc-4-next').click(_ => {
      $('#bcc-4').slideUp(200, _ => {
        $('#bcc-5').slideDown(200)
      })
      $('#bcc-5').trigger('prep')
    })

    $('#bcc-ctis').on('clear', (_, key) => {
      delete cards[key].ctis
    })

    $('#bcc-ctis').on('edit', (_, key) => {
      let card = cards[key]
      $('#bcc-ctis-type').val(card.type || '')
      $('#bcc-ctis-text').val(card.text || '')
      $('#bcc-ctis-edit').val(card.ctis || '')
      $('#bcc-ctis').fadeIn(200)
      $('#bcc-ctis-close, #bcc-ctis-save').on('click', function (e) {
        if ($(this).attr('id') === 'bcc-ctis-save') card.ctis = $('#bcc-ctis-edit').val()
        $('#bcc-ctis').fadeOut(200)
        $('#bcc-ctis-close, #bcc-ctis-save').off()
      })
    })

    $('#bcc-ctis-edit').on('keydown', function (e) {
      let keyCode = e.keyCode || e.which

      if (keyCode === 13) {
        e.preventDefault()
        let start = this.selectionStart
        let end = this.selectionEnd
        let depth = ($(this).val().substr(0, start).match(/{|\[/g) || []).length - ($(this).val().substr(0, start).match(/}|\]/g) || []).length
        let spacing = '\n'
        for (let i = 0; i < depth; i++) {
          spacing += '  '
        }
        $(this).val($(this).val().substr(0, start) + spacing + $(this).val().substring(end))
        this.selectionEnd = start + spacing.length
      } else if (keyCode === 221) {
        let start = this.selectionStart
        let end = this.selectionEnd
        if ($(this).val().substr(start - 2, start - 1) === '  ') {
          this.selectionStart -= 2
          $(this).val($(this).val().substr(0, start) + $(this).val().substring(end))
        }
      }
    })

    $('#bcc-5').on('prep', _ => {
      let progressbar = new mdc.linearProgress.MDCLinearProgress($('#bcc-5-progress')[0])
      progressbar.foundation_.setProgress(0)
      progressbar.foundation_.setBuffer(0)
      let max = Object.keys(cards).length
      let progress = 0
      let buffer = 0
      SaveCards(settings('type')).then(_ => {
        setTimeout(_ => {
          $('#bcc-5').slideUp(200, _ => {
            $('#bcc-6').slideDown(200)
          })
          $('#bcc-6').trigger('prep')
        }, 500)
      }, (err) => {
        if (err !== undefined) console.error('Error whilst saving cards:\n', err)
      }, (prog) => {
        if (prog === 'buffer') progressbar.foundation_.setBuffer(++buffer / max - 1)
        else if (prog === 'progress') progressbar.foundation_.setProgress(++progress / max - 1)
      })
    })
  })

  $('#bcc-6').on('prep', _ => {
    $('#bcc-saveLoc').text(settings('saveFolder'))
  })
</script>
